# Run order (generated by Full-Orchestrator)

Run these commands in order from the **generated project root** (this directory, or `./output` when generated).

**Who runs deploy?** Full-Orchestrator only **generates** this project; it does **not** run Terraform apply, build, or deploy. You can either:
- **Manual:** Follow the steps below (build + deploy).
- **Multi-Agent-Pipeline:** Point Multi-Agent-Pipeline (or Combined-Crew) at this output directory; it will run Infra → Build → Deploy → Verify for you.

---

## 1. Bootstrap (once)

```bash
cd infra/bootstrap
terraform init
terraform apply -auto-approve
```

Copy bootstrap outputs into env config:

```bash
# From infra/bootstrap after apply:
terraform output -raw tfstate_bucket      # → backend.hcl: bucket
terraform output -raw tflock_table       # → backend.hcl: dynamodb_table
terraform output -raw cloudtrail_bucket  # → dev.tfvars and prod.tfvars: cloudtrail_bucket
```

Update `infra/envs/dev/backend.hcl`, `infra/envs/prod/backend.hcl` (bucket, dynamodb_table), and `infra/envs/dev/dev.tfvars`, `infra/envs/prod/prod.tfvars` (cloudtrail_bucket).

## 2. Dev environment

```bash
cd infra/envs/dev
terraform init -backend-config=backend.hcl -reconfigure
terraform apply -auto-approve -var-file=dev.tfvars
```

## 3. Prod environment

```bash
cd infra/envs/prod
terraform init -backend-config=backend.hcl -reconfigure
terraform apply -auto-approve -var-file=prod.tfvars
```

## 4. OIDC (GitHub Actions, optional)

Create IAM OIDC provider and role for your GitHub repo, then add secrets: AWS_ROLE_TO_ASSUME, AWS_REGION. Skip if you deploy only manually.

---

## 5. Build (Docker → ECR → SSM)

From the **project root** (this directory), after dev and prod are applied:

```bash
export AWS_REGION=us-east-1
export ENV=prod
# Get ECR repo name from Terraform (e.g. prod)
ECR_REPO=$(cd infra/envs/$ENV && terraform output -raw ecr_repo)
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
ECR_URI=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO
IMAGE_TAG=$(git rev-parse --short HEAD 2>/dev/null || echo "latest")

# Build and push
docker build -t $ECR_URI:$IMAGE_TAG ./app
aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
docker push $ECR_URI:$IMAGE_TAG

# Tell the platform which image to deploy (CodeDeploy/Ansible read this)
aws ssm put-parameter --name "/bluegreen/$ENV/image_tag" --type String --value "$IMAGE_TAG" --overwrite --region $AWS_REGION
```

For **dev**, repeat with `ENV=dev` and the dev ECR repo.

---

## 6. Deploy (choose one)

### Option A — CodeDeploy

From project root:

```bash
export AWS_REGION=us-east-1
export ENV=prod
BUCKET=$(cd infra/envs/$ENV && terraform output -raw artifacts_bucket)
APP=$(cd infra/envs/$ENV && terraform output -raw codedeploy_app)
GROUP=$(cd infra/envs/$ENV && terraform output -raw codedeploy_group)

# Create deploy bundle and upload
(cd deploy && zip -r ../deploy.zip .)
S3_KEY=deploy-$(date +%Y%m%d%H%M%S).zip
aws s3 cp deploy.zip s3://$BUCKET/$S3_KEY

# Trigger deployment
aws deploy create-deployment \
  --application-name $APP \
  --deployment-group-name $GROUP \
  --s3-location bucket=$BUCKET,key=$S3_KEY,bundleType=zip \
  --region $AWS_REGION
```

### Option B — Ansible

From project root:

```bash
# Install Ansible collections (once)
ansible-galaxy collection install -r ansible/requirements.yml

# Deploy to prod (SSM connection; EC2s must have SSM agent and correct IAM)
export AWS_REGION=us-east-1
SSM_BUCKET=$(cd infra/envs/prod && terraform output -raw artifacts_bucket)
ansible-playbook -i ansible/inventory/ec2_prod.aws_ec2.yml ansible/playbooks/deploy.yml -e ssm_bucket=$SSM_BUCKET -e env=prod -e ssm_region=$AWS_REGION
```

For **dev**, use inventory `ansible/inventory/ec2_dev.aws_ec2.yml` and `env=dev`, and get `SSM_BUCKET` from `infra/envs/dev`.

---

## 7. Verify (optional)

```bash
# Health check (use your app URL from Terraform output)
curl -sf https://dev-app.example.com/health
# Or: cd infra/envs/prod && terraform output https_url
```

---

This deployment project was generated with Terraform infrastructure code for bootstrap, platform module, dev and prod environments, plus a sample Node.js app with Dockerfile, CodeDeploy bundle, and GitHub Actions workflows.

Validation results:
- Terraform validate succeeded in infra/bootstrap.
- Terraform validate failed in infra/envs/dev and infra/envs/prod due to an unsupported argument 'enable_cloudtrail' in module platform. You may need to adjust your platform module or environment configs accordingly.
- Docker build skipped because Docker was not found in PATH.

To deploy, start with terraform init and apply in infra/bootstrap, then platform module, then environments, then build and deploy the app.

Refer to this RUN_ORDER.md for the exact commands.
