---
# Deploy app to EC2 via SSM (no SSH). Use with pipeline DEPLOY_METHOD=ansible.
# From repo root: ansible-playbook -i ansible/inventory/ec2_prod.aws_ec2.yml ansible/playbooks/deploy.yml -e ssm_bucket=BUCKET -e env=prod
# Get bucket: terraform output -raw artifacts_bucket (from infra/envs/prod or dev)
- name: Deploy app (pull ECR image, run container)
  hosts: all
  gather_facts: false
  connection: community.aws.aws_ssm
  become: true
  vars:
    deploy_env: "{{ env | default('dev') }}"
    ansible_aws_ssm_bucket_name: "{{ ssm_bucket }}"
    ansible_aws_ssm_region: "{{ ssm_region | default('us-east-1') }}"
  tasks:
    - name: Require ssm_bucket
      ansible.builtin.assert:
        that: ssm_bucket is defined and ssm_bucket | length > 0
        fail_msg: "Pass -e ssm_bucket=BUCKET (from terraform output -raw artifacts_bucket)"
      tags: always
    - name: Stop existing container
      ansible.builtin.shell: docker rm -f bluegreen-app 2>/dev/null || true
      args:
        executable: /bin/bash
      register: stop_out
      failed_when: false
    - name: Deploy (pull image, run container)
      ansible.builtin.shell: |
        set -e
        ENV=$(cat /opt/bluegreen-env 2>/dev/null || echo "{{ deploy_env }}")
        REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region 2>/dev/null || echo "{{ ssm_region | default('us-east-1') }}")
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        ECR_REPO=$(aws ssm get-parameter --name "/bluegreen/${ENV}/ecr_repo_name" --region "$REGION" --query Parameter.Value --output text)
        IMAGE_TAG=$(aws ssm get-parameter --name "/bluegreen/${ENV}/image_tag" --region "$REGION" --query Parameter.Value --output text)
        [[ -z "$IMAGE_TAG" || "$IMAGE_TAG" == "unset" || "$IMAGE_TAG" == "initial" ]] && { echo "ERROR: /bluegreen/${ENV}/image_tag not set"; exit 1; }
        ECR_URI="${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}"
        aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com"
        docker pull "$ECR_URI"
        docker run -d --name bluegreen-app -p 8080:8080 -e APP_VERSION="$IMAGE_TAG" --restart unless-stopped "$ECR_URI"
      args:
        executable: /bin/bash
    - name: Wait for app
      ansible.builtin.wait_for: { port: 8080, host: 127.0.0.1, delay: 2, timeout: 30 }
    - name: Validate /health
      ansible.builtin.shell: curl -sf http://localhost:8080/health
      register: validate_out
      failed_when: validate_out.rc != 0
